import { createElement } from 'lwc';
import ApmMyAssessment from 'c/apmMyAssessment';
import getPendingApplications from '@salesforce/apex/APM_apLWC_MyAssessmentController.getPendingAssessments';

jest.mock(
    '@salesforce/apex/APM_apLWC_MyAssessmentController.getPendingAssessments',
    () => ({
        default: jest.fn()
    }),
    { virtual: true }
);

jest.mock(
    '@salesforce/label/c.APM_Attestation_Link',
    () => 'https://assessment-link.com',
    { virtual: true }
);

describe('c-apm-my-assessment', () => {
    afterEach(() => {
        while (document.body.firstChild) {
            document.body.removeChild(document.body.firstChild);
        }
        jest.clearAllMocks();
    });

    it('renders application list correctly', async () => {
        const mockData = Array.from({ length: 10 }, (_, i) => ({
            Id: `app${i + 1}`,
            Name: `Application ${i + 1}`
        }));

        getPendingApplications.mockResolvedValue(mockData);

        const element = createElement('c-apm-my-assessment', {
            is: ApmMyAssessment
        });

        document.body.appendChild(element);
        await Promise.resolve(); // Let wire load
        await Promise.resolve(); // Let DOM update

        const rendered = element.shadowRoot.querySelectorAll('[data-id]');
        expect(rendered.length).toBe(8); // PAGE_SIZE = 8
    });

    it('handles Apex error gracefully and shows nothing', async () => {
        getPendingApplications.mockRejectedValue(new Error('Apex failure'));

        const element = createElement('c-apm-my-assessment', {
            is: ApmMyAssessment
        });

        document.body.appendChild(element);
        await Promise.resolve();
        await Promise.resolve();

        const items = element.shadowRoot.querySelectorAll('[data-id]');
        expect(items.length).toBe(0);
    });

    it('opens modal on handleViewAll and closes on handleCloseModal', () => {
        const element = createElement('c-apm-my-assessment', {
            is: ApmMyAssessment
        });
        document.body.appendChild(element);

        // Initially no modal
        expect(element.shadowRoot.querySelector('.modal')).toBeNull();

        element.handleViewAll();
        return Promise.resolve().then(() => {
            expect(element.shadowRoot.querySelector('.modal')).not.toBeNull();

            element.handleCloseModal();
            return Promise.resolve().then(() => {
                expect(element.shadowRoot.querySelector('.modal')).toBeNull();
            });
        });
    });

    it('navigates using next/prev buttons and updates items', async () => {
        const mockData = Array.from({ length: 10 }, (_, i) => ({
            Id: `app${i + 1}`,
            Name: `App ${i + 1}`
        }));

        getPendingApplications.mockResolvedValue(mockData);

        const element = createElement('c-apm-my-assessment', {
            is: ApmMyAssessment
        });

        document.body.appendChild(element);
        await Promise.resolve();
        await Promise.resolve();

        let items = element.shadowRoot.querySelectorAll('[data-id]');
        expect(items.length).toBe(8); // Page 1

        element.handleNext();
        await Promise.resolve();
        await Promise.resolve();

        items = element.shadowRoot.querySelectorAll('[data-id]');
        expect(items.length).toBe(2); // Page 2

        element.handlePrev();
        await Promise.resolve();
        await Promise.resolve();

        items = element.shadowRoot.querySelectorAll('[data-id]');
        expect(items.length).toBe(8); // Back to Page 1
    });

    it('opens window with full link when Take Assessment is clicked', async () => {
        getPendingApplications.mockResolvedValue([{ Id: '001XYZ', Name: 'Test App' }]);

        const element = createElement('c-apm-my-assessment', {
            is: ApmMyAssessment
        });
        document.body.appendChild(element);
        await Promise.resolve();
        await Promise.resolve();

        const openSpy = jest.spyOn(window, 'open').mockImplementation(() => {});

        const takeBtn = element.shadowRoot.querySelector('[data-id="001XYZ"]');
        expect(takeBtn).toBeTruthy();
        takeBtn.click();

        expect(openSpy).toHaveBeenCalledWith(
            expect.stringContaining('https://assessment-link.com'),
            '_blank'
        );

        openSpy.mockRestore();
    });
});
